<div class="page-shell">
  <div class="header-row">
    <div>
      <h2 class="page-title">Lịch sử thuê</h2>
      <p class="page-sub">Xem các lần thuê phòng và thực hiện trả phòng / đánh giá.</p>
    </div>
    <button type="button" class="btn primary" (click)="fetch()">Tải lại</button>
  </div>

  <div *ngIf="error" class="status error">{{ error }}</div>
  <div *ngIf="message" class="status info">{{ message }}</div>

  <div class="tabs">
    <button type="button" class="tab" [class.active]="activeTab==='ACTIVE'" (click)="setTab('ACTIVE')">Đang thuê</button>
    <button type="button" class="tab" [class.active]="activeTab==='ENDED'" (click)="setTab('ENDED')">Đã trả</button>
    <button type="button" class="tab" [class.active]="activeTab==='PENDING_RENT'" (click)="setTab('PENDING_RENT')">
      Chờ duyệt thuê
      <span class="tab-badge" *ngIf="pendingRentCount > 0">{{ pendingRentCount }}</span>
    </button>
    <button type="button" class="tab" [class.active]="activeTab==='PENDING_RETURN'" (click)="setTab('PENDING_RETURN')">
      Chờ duyệt trả
      <span class="tab-badge" *ngIf="pendingReturnCount > 0">{{ pendingReturnCount }}</span>
    </button>
    <button type="button" class="tab" [class.active]="activeTab==='PROCESSED'" (click)="setTab('PROCESSED')">
      Đã xử lý
    </button>
  </div>

  <div class="list" *ngIf="activeTab==='ACTIVE' && activeRentals.length">
    <article class="card" *ngFor="let x of activeRentals">
      <div class="card-head">
        <div>
          <div class="card-title">{{ getRoomTitle(x) }}</div>
          <div class="card-sub" *ngIf="getRoomAddress(x)">{{ getRoomAddress(x) }}</div>
        </div>
        <span class="chip" [class.active]="canReturn(x)" [class.done]="canReview(x)">{{ x.status }}</span>
      </div>

      <div class="card-grid">
        <div class="kv">
          <div class="k">Bắt đầu</div>
          <div class="v">{{ x.startDate | date:'dd/MM/yyyy' }}</div>
        </div>
        <div class="kv">
          <div class="k">Kết thúc</div>
          <div class="v">{{ (x.endDate || '-') }}</div>
        </div>
        <div class="kv">
          <div class="k">Giá/tháng</div>
          <div class="v">{{ x.monthlyPrice | number:'1.0-0' }} đ</div>
        </div>
        <div class="kv">
          <div class="k">Tiền cọc</div>
          <div class="v">{{ x.deposit | number:'1.0-0' }} đ</div>
        </div>
      </div>

      <div class="section" *ngIf="canReturn(x)">
        <div class="section-title">Trả phòng</div>
        <div class="field">
          <textarea class="field-control" rows="3" [(ngModel)]="returnNote[x.id]" placeholder="Ghi chú trả phòng (ngày dự kiến trả, lý do, liên hệ...)" ></textarea>
        </div>
        <div class="actions">
          <button type="button" class="btn primary" (click)="sendReturnRequest(x)">Gửi yêu cầu trả phòng</button>
        </div>
      </div>

      <div class="section" *ngIf="canReview(x)">
        <div class="section-title">Đánh giá</div>
        <div class="form-row">
          <label class="field">
            <span class="field-label">Số sao (1-5)</span>
            <input class="field-control" type="number" min="1" max="5" [(ngModel)]="getReviewDraft(x).rating" />
          </label>
          <label class="field">
            <span class="field-label">Bình luận</span>
            <input class="field-control" type="text" [(ngModel)]="getReviewDraft(x).comment" placeholder="Viết ngắn gọn trải nghiệm của bạn" />
          </label>
        </div>
        <div class="actions">
          <button type="button" class="btn primary" (click)="submitReview(x)">Gửi đánh giá</button>
        </div>
      </div>
    </article>
  </div>

  <div class="list" *ngIf="activeTab==='ENDED' && endedRentals.length">
    <article class="card" *ngFor="let x of endedRentals">
      <div class="card-head">
        <div>
          <div class="card-title">{{ getRoomTitle(x) }}</div>
          <div class="card-sub" *ngIf="getRoomAddress(x)">{{ getRoomAddress(x) }}</div>
        </div>
        <span class="chip" [class.active]="canReturn(x)" [class.done]="canReview(x)">{{ x.status }}</span>
      </div>

      <div class="card-grid">
        <div class="kv">
          <div class="k">Bắt đầu</div>
          <div class="v">{{ x.startDate | date:'dd/MM/yyyy' }}</div>
        </div>
        <div class="kv">
          <div class="k">Kết thúc</div>
          <div class="v">{{ (x.endDate || '-') }}</div>
        </div>
        <div class="kv">
          <div class="k">Giá/tháng</div>
          <div class="v">{{ x.monthlyPrice | number:'1.0-0' }} đ</div>
        </div>
        <div class="kv">
          <div class="k">Tiền cọc</div>
          <div class="v">{{ x.deposit | number:'1.0-0' }} đ</div>
        </div>
      </div>

      <div class="section" *ngIf="canReview(x)">
        <div class="section-title">Đánh giá</div>
        <div class="form-row">
          <label class="field">
            <span class="field-label">Số sao (1-5)</span>
            <input class="field-control" type="number" min="1" max="5" [(ngModel)]="getReviewDraft(x).rating" />
          </label>
          <label class="field">
            <span class="field-label">Bình luận</span>
            <input class="field-control" type="text" [(ngModel)]="getReviewDraft(x).comment" placeholder="Viết ngắn gọn trải nghiệm của bạn" />
          </label>
        </div>
        <div class="actions">
          <button type="button" class="btn primary" (click)="submitReview(x)">Gửi đánh giá</button>
        </div>
      </div>
    </article>
  </div>

  <div class="list" *ngIf="activeTab==='PENDING_RENT' && pendingRentRequests.length">
    <article class="card" *ngFor="let r of pendingRentRequests">
      <div class="card-head">
        <div>
          <div class="card-title">{{ r.hostelName ? (r.hostelName + ' - ') : '' }}{{ r.roomTitle || ('#' + r.roomId) }}</div>
          <div class="card-sub">Loại: Thuê phòng</div>
        </div>
        <span class="chip">{{ getRequestStatusLabel(r.status) }}</span>
      </div>
      <div class="meta">{{ (r.sentAt || r.sentDate) | date:'short' }}</div>
      <div class="note">{{ r.note }}</div>
    </article>
  </div>

  <div class="list" *ngIf="activeTab==='PENDING_RETURN' && pendingReturnRequests.length">
    <article class="card" *ngFor="let r of pendingReturnRequests">
      <div class="card-head">
        <div>
          <div class="card-title">{{ r.hostelName ? (r.hostelName + ' - ') : '' }}{{ r.roomTitle || ('#' + r.roomId) }}</div>
          <div class="card-sub">Loại: Trả phòng</div>
        </div>
        <span class="chip">{{ getRequestStatusLabel(r.status) }}</span>
      </div>
      <div class="meta">{{ (r.sentAt || r.sentDate) | date:'short' }}</div>
      <div class="note">{{ r.note }}</div>
    </article>
  </div>

  <div class="list" *ngIf="activeTab==='PROCESSED' && processedRequests.length">
    <article class="card" *ngFor="let r of processedRequests">
      <div class="card-head">
        <div>
          <div class="card-title">{{ r.hostelName ? (r.hostelName + ' - ') : '' }}{{ r.roomTitle || ('#' + r.roomId) }}</div>
          <div class="card-sub">Loại: {{ normalizeType(r.requestType) === 'RETURN' ? 'Trả phòng' : 'Thuê phòng' }}</div>
        </div>
        <span class="chip" [class.done]="normalizeStatus(r.status)==='ACCEPTED'" [class.danger]="normalizeStatus(r.status)==='REJECTED'">{{ getRequestStatusLabel(r.status) }}</span>
      </div>
      <div class="meta">{{ (r.sentAt || r.sentDate) | date:'short' }}</div>
      <div class="note">{{ r.note }}</div>
    </article>
  </div>
</div>
