<div class="listing-search-page">
  <!-- Hero Section với Search -->
  <section class="hero-section">
    <div class="hero-content">
      <div class="hero-text">
        <h1 class="hero-title">
          <span class="material-symbols-outlined">home</span>
          Tìm Phòng Trọ Ưng Ý
        </h1>
        <p class="hero-subtitle">Khám phá hàng nghìn phòng trọ chất lượng với giá cả phải chăng</p>
        <div class="hero-stats" *ngIf="!error">
          <div class="stat-item">
            <span class="material-symbols-outlined">apartment</span>
            <span><strong>{{ filteredListings.length }}</strong> phòng</span>
          </div>
        </div>
      </div>

      <!-- Search Box -->
      <div class="search-container">
        <div class="search-box">
          <span class="material-symbols-outlined search-icon">search</span>
          <input type="text" [(ngModel)]="searchTerm" placeholder="Tìm theo địa điểm, tên phòng trọ..."
            class="search-input" />
          <button type="button" class="filter-toggle-btn" (click)="toggleFilters()" [class.active]="showFilters">
            <span class="material-symbols-outlined">tune</span>
            <span>Bộ lọc</span>
          </button>
          <button type="button" class="reload-btn" (click)="fetch()">
            <span class="material-symbols-outlined">refresh</span>
          </button>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel" *ngIf="showFilters">
          <div class="filter-header">
            <h3>
              <span class="material-symbols-outlined">filter_list</span>
              Lọc kết quả
            </h3>
            <button type="button" class="clear-btn" (click)="clearFilters()">
              <span class="material-symbols-outlined">close</span>
              Xóa bộ lọc
            </button>
          </div>

          <div class="filter-content">
            <!-- Location Filters -->
            <div class="filter-group">
              <div class="filter-group-title">
                <span class="material-symbols-outlined">location_on</span>
                Khu vực
              </div>
              <div class="location-grid">
                <div class="location-field">
                  <label>Tỉnh/Thành phố</label>
                  <select [(ngModel)]="selectedProvince" (ngModelChange)="onProvinceChange()">
                    <option value="">Toàn quốc</option>
                    <option *ngFor="let p of provinceOptions" [value]="p">{{ p }}</option>
                  </select>
                </div>

                <div class="location-field">
                  <label>Quận/Huyện</label>
                  <select [(ngModel)]="selectedDistrict" (ngModelChange)="onDistrictChange()"
                    [disabled]="!selectedProvince">
                    <option value="">Tất cả</option>
                    <option *ngFor="let d of districtOptions" [value]="d">{{ d }}</option>
                  </select>
                </div>

                <div class="location-field">
                  <label>Phường/Xã</label>
                  <select [(ngModel)]="selectedWard" [disabled]="!selectedDistrict">
                    <option value="">Tất cả</option>
                    <option *ngFor="let w of wardOptions" [value]="w">{{ w }}</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Price Range -->
            <div class="filter-group">
              <div class="filter-group-title">
                <span class="material-symbols-outlined">payments</span>
                Khoảng giá
              </div>
              <div class="chip-group">
                <button type="button" class="chip" *ngFor="let r of priceRanges"
                  [class.active]="selectedPriceRange === r.key" (click)="selectPriceRange(r.key)">
                  {{ r.label }}
                </button>
              </div>
            </div>

            <!-- Area Range -->
            <div class="filter-group">
              <div class="filter-group-title">
                <span class="material-symbols-outlined">square_foot</span>
                Diện tích
              </div>
              <div class="chip-group">
                <button type="button" class="chip" *ngFor="let r of areaRanges"
                  [class.active]="selectedAreaRange === r.key" (click)="selectAreaRange(r.key)">
                  {{ r.label }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Error Message -->
  <div class="error-message" *ngIf="error">
    <span class="material-symbols-outlined">error</span>
    <span>{{ error }}</span>
  </div>

  <!-- Results Section -->
  <section class="results-section" *ngIf="filteredListings.length; else emptyState">
    <div class="results-grid">
      <article class="listing-card" *ngFor="let p of filteredListings">
        <!-- Image -->
        <div class="listing-image">
          <img *ngIf="getFirstImage(p); else noImage" [src]="getFirstImage(p)!" alt="Ảnh phòng" loading="lazy" />
          <ng-template #noImage>
            <div class="image-placeholder">
              <span class="material-symbols-outlined">image</span>
              <span>Chưa có ảnh</span>
            </div>
          </ng-template>

          <div class="listing-badges">
            <span class="badge badge-new" *ngIf="p.isNew">
              <span class="material-symbols-outlined">fiber_new</span>
              Mới
            </span>
          </div>

          <button type="button" class="favorite-btn" title="Yêu thích">
            <span class="material-symbols-outlined">favorite</span>
          </button>

          <div class="price-tag" *ngIf="p.price">
            <span class="material-symbols-outlined">payments</span>
            <span>{{ p.price | number:'1.0-0' }}₫/tháng</span>
          </div>
        </div>

        <!-- Content -->
        <div class="listing-content">
          <h3 class="listing-title">{{ p.title }}</h3>

          <div class="listing-address">
            <div class="address-full" *ngIf="p.address">
              <span class="material-symbols-outlined">location_on</span>
              <span>{{ p.address }}</span>
            </div>
            <div class="address-location" *ngIf="p.ward || p.district || p.province">
              <span class="material-symbols-outlined">place</span>
              <span>
                <ng-container *ngIf="p.ward">{{ p.ward }}, </ng-container>
                <ng-container *ngIf="p.district">{{ p.district }}, </ng-container>
                <ng-container *ngIf="p.province">{{ p.province }}</ng-container>
              </span>
            </div>
          </div>

          <p class="listing-description">{{ p.description || 'Chưa có mô tả chi tiết.' }}</p>

          <div class="listing-meta">
            <div class="meta-item" *ngIf="p.area">
              <span class="material-symbols-outlined">square_foot</span>
              <span>{{ p.area }}m²</span>
            </div>
            <div class="meta-item" *ngIf="p.createdAt">
              <span class="material-symbols-outlined">calendar_today</span>
              <span>{{ p.createdAt | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>

          <div class="listing-footer">
            <div class="rating" *ngIf="p.rating">
              <span class="material-symbols-outlined filled">star</span>
              <span class="rating-value">{{ p.rating | number:'1.1-1' }}</span>
              <span class="rating-count" *ngIf="p.ratingCount">({{ p.ratingCount }})</span>
            </div>

            <a [routerLink]="['/listings', p.id]" class="view-detail-btn">
              <span>Xem chi tiết</span>
              <span class="material-symbols-outlined">arrow_forward</span>
            </a>
          </div>
        </div>
      </article>
    </div>
  </section>

  <!-- Empty State -->
  <ng-template #emptyState>
    <div class="empty-state" *ngIf="!error">
      <div class="empty-icon">
        <span class="material-symbols-outlined">search_off</span>
      </div>
      <h3>Không tìm thấy phòng trọ</h3>
      <p>Thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
      <button type="button" class="btn-primary-gradient" (click)="clearFilters()">
        <span class="material-symbols-outlined">refresh</span>
        <span>Xóa bộ lọc</span>
      </button>
    </div>
  </ng-template>
</div>